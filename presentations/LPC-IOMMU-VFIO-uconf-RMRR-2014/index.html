<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Handling device identity mappings in the IOMMU API</title>

		<meta name="description" content="Handling device identity mappings in the IOMMU API">
		<meta name="author" content="Alex Williamson">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/redhat.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
		<link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon" />

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
			<a id="logo-white"><img src="../images/Red_Hat_RGB_reverse.png" alt=""/></a>
			<a id="logo-black"><img src="../images/Red_Hat_RGB.png" alt=""/></a>

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h3>Handling device identity mappings</h3>
					<h3>in the IOMMU API</h3>
					<p><small>AKA: Please stop abusing RMRRs</small></p>
					<p>Alex Williamson / alex.williamson@redhat.com</p>
				</section>

				<section>
					<h3>What are identity mappings?</h3>
					<p class="fragment" align="left">RMRR - <u>R</u>eserved <u>M</u>emory <u>R</u>egion <u>R</u>eporting Structure</p>
					<ul>
						<li class="fragment">Defined in the Intel VT-d spec</li>
						<li class="fragment">Specified by the BIOS (platform) via ACPI tables</li>
						<li class="fragment">Identifies a memory region and set of devices</li>
						<li class="fragment">Requires persistent access between memory &amp; device(s)</li>
						<li class="fragment">1:1 address mapping</li>
					</ul>
				</section>

				<section>
					<h3>The spec says...</h3>
					<blockquote style="width:120%;margin-left:-10%" align="justify">
						&ldquo;The RMRR regions are expected to be used for legacy usages (such as USB, UMA Graphics, etc.) requiring reserved memory. <b>Platform designers should avoid or limit use of reserved memory regions since these require system software to create holes in the DMA virtual address range available to system software and its drivers.</b>&rdquo;
					</blockquote>
					<p><small>VT-d spec, rev 2.2, section 8.4</small></p>

				</section>

				<section>
					<h3>Vendor response...</h3>
					<div style="width:124%; margin-left:-12%">
					<pre><code>
IOMMU: Setting RMRR:
IOMMU: Setting identity map for device 0000:02:00.0 [0xbdf7f000 - 0xbdf8efff] (Smart Array)
IOMMU: Setting identity map for device 0000:01:00.0 [0xbdf7f000 - 0xbdf8efff] (iLO)
IOMMU: Setting identity map for device 0000:01:00.2 [0xbdf7f000 - 0xbdf8efff] (iLO)
IOMMU: Setting identity map for device 0000:03:00.0 [0xbdf7f000 - 0xbdf8efff] (BCM57810)
IOMMU: Setting identity map for device 0000:03:00.1 [0xbdf7f000 - 0xbdf8efff] (BCM57810)
IOMMU: Setting identity map for device 0000:02:00.0 [0xbdf8f000 - 0xbdf92fff] (Smart Array)
IOMMU: Setting identity map for device 0000:01:00.0 [0xbdf8f000 - 0xbdf92fff] (iLO)
IOMMU: Setting identity map for device 0000:01:00.2 [0xbdf8f000 - 0xbdf92fff] (iLO)
IOMMU: Setting identity map for device 0000:03:00.0 [0xbdf8f000 - 0xbdf92fff] (BCM57810)
IOMMU: Setting identity map for device 0000:03:00.1 [0xbdf8f000 - 0xbdf92fff] (BCM57810)
IOMMU: Setting identity map for device 0000:02:00.0 [0xbdf93000 - 0xbdf94fff] (Smart Array)
IOMMU: Setting identity map for device 0000:01:00.0 [0xbdf93000 - 0xbdf94fff] (iLO)
IOMMU: Setting identity map for device 0000:01:00.2 [0xbdf93000 - 0xbdf94fff] (iLO)
IOMMU: Setting identity map for device 0000:03:00.0 [0xbdf93000 - 0xbdf94fff] (BCM57810)
IOMMU: Setting identity map for device 0000:03:00.1 [0xbdf93000 - 0xbdf94fff] (BCM57810)
IOMMU: Setting identity map for device 0000:01:00.0 [0xbdff6000 - 0xbdffcfff] (iLO)
IOMMU: Setting identity map for device 0000:01:00.2 [0xbdff6000 - 0xbdffcfff] (iLO)
IOMMU: Setting identity map for device 0000:01:00.4 [0xbdff6000 - 0xbdffcfff] (iLO USB)
IOMMU: Setting identity map for device 0000:00:1d.0 [0xbdffd000 - 0xbdffffff] (EHCI)
IOMMU: Setting identity map for device 0000:00:1a.0 [0xbdffd000 - 0xbdffffff] (EHCI)
					</code></pre>
					</div>
					<p><small>HP DL560 Gen8</small></p>
				</section>

				<section>
					<h3>Why is this a problem?</h3>
					<div align="left">
					<p class="fragment">dma_ops</p>
					<ul>
						<li class="fragment">IOMMU driver defines device IOVA space</li>
						<li class="fragment">RMRRs are handled properly (mostly)</li>
					</ul>
					<p>&nbsp;</p>
					<p class="fragment">IOMMU API</p>
					<ul>
						<li class="fragment">API user defines device IOVA space</li>
						<li class="fragment">RMRRs are ignored</li>
						<ul>
							<li class="fragment">device may continue to write to RMRR area</li>
								<ul><li class="fragment">may result in IOMMU faults</li></ul>
							<li class="fragment">RMRR IOVA may be remapped</li>
								<ul><li class="fragment">potentially worse failure modes</li></ul>
						</ul>
					</ul>
					</div>
				</section>

				<section>
					<h3>Current solution:</h3>
					<p>&nbsp;</p>
					<p class="fragment">Exclude devices with RMRRs from the IOMMU API</p>
				</section>

				<section>
					<h3>Do we want to do better?</h3>
					<p>&nbsp;</p>
					<h3 class="fragment">How?</h3>
					<p>&nbsp;</p>
					<h3 class="fragment">Discuss...</h3>
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Parallax scrolling
				// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
